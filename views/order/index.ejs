<!--
TODO:
    Add a way to add new PO and a way to copy existing PO as a new one
    Add way to see manifest list. maybe popup when mouseover delivered amt.
-->
<div data-bind="with: OrdersVM">
    <div style="position: fixed; right: 0px">
        <button class="btn btn-success"
                data-toggle="tooltip" data-placement="bottom" title="Alt+N">
            新訂單
        </button>
        <button class="btn btn-success"
                onclick="$('#helpModal').modal('show');"
                data-toggle="tooltip" data-placement="bottom" title="F1">
            Help
        </button>
    </div>

  <table class="table table-condensed table-striped">
    <thead>
        <th>選</th>
        <th>日期</th>
        <th>賣家</th>
        <th>買主</th>
        <th>PO#</th>
        <th>品名</th>
        <th>訂量</th>
        <th>已送</th>
        <th>價格</th>
        <th>納稅</th>
        <th>備註</th>
    </thead>
    <tbody data-bind="foreach: orders">
        <tr data-bind="click: function (data, event) { $parent.rowClick(event, $index()); return true; },
                       css: {'highlight-row': is_open && isSelected,
                             'archived-row': !is_open() && !isSelected(),
                             'highlight-archived-row': !is_open() && isSelected},
                       attr: {id: 'rec-' + $index()}">
            <td style="width: 2em">
                <div class="dropdown">
                    <button class="btn btn-custom btn-xs dropdown-toggle"
                            data-bind="attr: {id: 'dropdown' + $index()},
                                       visible: !isEditing()"
                            data-toggle="dropdown"
                            aria-haspopup="true" aria-expanded="false"
                            role="button">
                        <i class="fa fa-bars"></i>
                    </button>
                    <div class="dropdown-menu"
                        data-bind="attr: {'aria-labelledby': 'dropdown' + $index()}">
                        <div class="btn-group-vertical">
                            <button class="btn btn-success" style="text-align: left"
                                data-bind="click: function () { $parent.toggleSelection($index()) }">
                                <i class="fa fa-pencil-square-o fa-fw fa-lg"></i> 切換選擇 (Ctrl+左鍵)
                            </button>
                            <button class="btn btn-success" style="text-align: left"
                                data-bind="click: function (data) { $parent.editButton($index(), data); }">
                                <i class="fa fa-pencil-square-o fa-fw fa-lg"></i> 編輯訂單
                            </button>
                            <button disabled class="btn btn-success" style="text-align: left">
                                <i class="fa fa-list-alt fa-fw fa-lg"></i> 看出貨單
                            </button>
                            <button disabled class="btn btn-success" style="text-align: left">
                                <i class="fa fa-files-o fa-fw fa-lg"></i> 複製舊訂單
                            </button>
                            <button class="btn btn-success" style="text-align: left"
                                    data-bind="visible: !is_open(), click: function (data) {$parent.toggleOpen(data)}">
                                <i class="fa fa-refresh fa-fw fa-lg"></i> 再開啟訂單
                            </button>
                            <button class="btn btn-warning" style="text-align: left"
                                    data-bind="visible: is_open, click: function (data) {$parent.toggleOpen(data)}">
                                <i class="fa fa-ban fa-fw fa-lg"></i> 結束訂單並歸檔
                            </button>
                            <button class="btn btn-danger" style="text-align: left"
                                data-bind="click: function (data) {data.isConfirmingDelete(true)}">
                                <i class="fa fa-trash fa-fw fa-lg"></i> 刪除訂單
                            </button>
                        </div>
                    </div>
                </div>
                <div class="btn-group-vertical btn-group-sm"
                     data-bind="visible: isEditing">
                    <button class="btn btn-danger has-tooltip"
                            data-bind="click: $parent.editCancelButton($index())"
                            data-toggle="tooltip" data-placement="top" title="關閉編輯視窗">
                        <i class="fa fa-close fa-lg"></i>
                    </button>
                    <button class="btn btn-primary has-tooltip"
                            data-bind="attr: {onclick: 'viewModel.OrdersVM.editSaveButton(this,' + $index() + ')'}"
                            data-toggle="tooltip" data-placement="bottom" title="儲存更改">
                        <i class="fa fa-floppy-o fa-lg"></i>
                    </button>
                </div>
            </td>
            <td has-input="orderdate">
                <div data-bind="text: $root.formatDate(orderdate())"></div>
                <input class="form-control" type="text" style="width: 10em"
                       data-bind="attr: {value: (new Date(orderdate())).toLocaleDateString()},
                                  visible: isEditing">
                <div class="alert alert-danger fade in text-center" role="alert"
                     data-bind="visible: isConfirmingDelete">
                    此動作無法回復<br>
                    <div class="btn-group btn-group-sm">
                        <button type="button" class="btn btn-primary"
                                data-bind="click: function (data) {data.isConfirmingDelete(false)}">
                            <i class="fa fa-backward fa-fw fa-lg"></i> 取消
                        </button>
                        <button type="button" class="btn btn-danger"
                                data-bind="click: function (data) {$parent.deleteRecord(data); data.isConfirmingDelete(false)}">
                            <i class="fa fa-trash fa-fw fa-lg"></i> 確認刪除
                        </button>
                    </div>
                </div>
                <div class="alert alert-danger fade in text-center" role="alert"
                     data-bind="visible: errorMessage, text: errorMessage">
                </div>
            </td>
            <td data-bind="text: seller"></td>
            <td data-bind="text: buyer"></td>
            <td has-input="orderID">
                <div data-bind="html: orderID() ? orderID : '<label class=\'badge\'>' + id() + '</label>'"></div>
                <input class="form-control" type="text" style="width: 10em"
                       placeholder="PO#"
                       data-bind="attr: {value: orderID()},
                                  visible: isEditing">
            </td>
            <td data-bind="text: MPN.inventory_name"></td>
            <td has-input="qty" align="right">
                <div data-bind="text: qty"></div>
                <input class="form-control text-right" type="text" style="width: 6em"
                       data-bind="attr: {value: qty()},
                                  visible: isEditing">
            </td>
            <td align="right">
                <div data-bind="text: qty_shipped"></div>
            </td>
            <td has-input="price" align="right">
                <div data-bind="text: '$' + price()"></div>
                <input class="form-control text-right" type="text" style="width: 6em"
                       data-bind="attr: {value: price()},
                                  visible: isEditing">
            </td>
            <td has-input="applytax">
                <div data-bind="html: applytax() ? '<i class=\'fa fa-lg fa-check-square-o\'></i>' : '<i class=\'fa fa-lg fa-square-o\'></i>'"></div>
                <input class="checkbox-30" type="checkbox"
                       data-bind="checked: applytax(),
                                  visible: isEditing">
            </td>
            <td has-input="ordernote" style="max-width: 300px">
                <div data-bind="text: ordernote"></div>
                <input class="form-control" type="text" placeholder="備註"
                       data-bind="attr: {value: ordernote()},
                                  visible: isEditing">
            </td>
        </tr>
    </tbody>
  </table>

    <%- partial ('modal.shipment.ejs') %>
    <%- partial ('modal.help.ejs') %>
</div><!--End of "with" div-->


<script><%- partial ('viewmodel.js') %></script>
